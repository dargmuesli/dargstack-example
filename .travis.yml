dist: bionic
services:
- docker
env:
  global:
  - COMMIT=${TRAVIS_COMMIT::8}
  - DOCKER_CLI_EXPERIMENTAL=enabled
  - REPO_NAME=dargmuesli
  - REPO_USER=dargstack-example
  - secure: e12fmsABeMIbcf3YZjez6L12ipXX7s+g3ip7wCMHSR4l6CjW4/5ZNLCCQXOuM8bXZR7K1rEYCR2EfIshXU3nF9/R5HulbU5CFK7+gK256X/aB/XmW2Pw4k7xkpQkB+WgwNQruMxN3hkEcX8Ius/We17+M4N7Vo7kYiRpsdT3L91NI0qTJkdjCzdyaajCEg9Zpw3pdon5Qfadji6KDsXRob/6WnnCb4GgbcEiQGZ52BI+mUmFhkjbQQngudD3B/ghCw0j68hIQ85wSohnolxyqvyGco17ezFVFrDvRkwh68TiX3yZ+DGJMTNtjJ7QsYRaGHCLt2rhvdz4bfqD0TxpSlnw+Ho6H9Uiwj3C7krVeUQHzmpBLK8/CKaQVfmTQe/31YrWKSoX3vlm7odhPZN/Ij5sJTdFAL0Kb6gWEoEF/kxdgk8y1din3UCpoAElQzIRiNBzFGyCAjdDLlZaSV+IA03GricVfBuDH/vCJ6HrnHo4AFgGTntjB9W0acIYlAuRqLLgG354UywZFEWZzxgUFY6flbOmUAvFVGZZQvdffihFvaI2Tg69XrT+cuc2Jba/C3g7ryiZcGUfv/3M7U1YYdmtEvEinRc8qNYt0kklPFTZe+GPQwTu4kFZq2SG8Zyyy3u/8h9w7bzEl5eJcuEOHJCIsBxv79UsFEUC3zoYwQg= #DOCKER_USER
  - secure: pmXWm0BCKuXAY9OrtHPH7cb21gpFfsJ9YZZjIvOfoiKy/OEL50DlHfljhzBHNTZcP85WE0T/K+HOLemm6nt2Z+HbooiNwWjSGaRLHVETsjYuM3l8odoSTcIaARPZ4kvt7ficlaDIuNPhJa8HV0eu+yQB+xBDSDi+h8kjFdQFdQy9++5rJJ29vK3nQx/1kBOIGURPbYoNNTINrrHl5fciFgHwaEPkUC1yAu8HiM/nHC0dHXxcBjCZLryw5pJz0gPdbt/PbqexGerH0p8xzoPwJ9LrB+kNPeZIE954tkie3a+hhLKjxi2MhBvA/kD/MwtKaSYzn2CFzbGreI1FRhFjbkmIJM+EEVlrgPqFE56MwvmJWXy1YskOGAsZH4zoVOmE9JzQMPZReGR1RQ5HHTOuYS2UocG+gZU45lIBPHgeqDbh6ZzWNh4jpdNmAdosivWm0CvS34hu102Lw69gMjJLtca8+TPO3zv4kT2ZyVLmLpgLq4qMAOqK+UrgZR35APOrVzPE3PZZBnC5XLLF8inG7tsOwGRkvKALJuFjP8NlLjU7gKv8l9dYWPZq7JB6nQm+Ksu7YBEvPhCeJigtIGuyMgE2KQW4MYKKn9WlFE/wThkNNIp524ITerAvzrugO6o8pJxAM1PFZz/cJL+uM5ZQiVBYUNeROciQMErpB/gIhM8= #DOCKER_PASS
before_install:
- echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
- export TAG=`if [ "$TRAVIS_BRANCH" == "master" ]; then echo "latest"; else echo $(echo $TRAVIS_BRANCH | tr / _); fi`
- |
    curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo apt-key add -
    sudo add-apt-repository "deb [arch=amd64] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable"
    sudo apt-get update
    sudo apt-get -y -o Dpkg::Options::="--force-confnew" install docker-ce
- |
    docker buildx create --name travis-builder --use
    docker buildx inspect --bootstrap
script:
- docker buildx build --cache-from=$REPO_USER/$REPO_NAME:cache --cache-to=$REPO_USER/$REPO_NAME:cache --push -t $REPO_USER/$REPO_NAME:$COMMIT -t $REPO_USER/$REPO_NAME:$TAG $PWD